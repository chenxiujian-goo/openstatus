name: Build & Package OpenStatus images (manual, fixed 1.0.0)

on:
  workflow_dispatch:   # 仅手动触发

env:
  REGISTRY_PREFIX: registry.byd.com/public/chenxiujian/openstatus
  FIXED_TAG: "1.0.0"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---------- 1. 拉取外部镜像 ----------
      - name: Pull external images
        run: |
          docker pull ghcr.io/tursodatabase/libsql-server:latest
          docker pull tinybirdco/tinybird-local:latest

      # ---------- 2. 构建自研镜像 ----------
      - name: Build self-developed images
        run: |
          docker compose build workflows server private-location dashboard status-page

      # ---------- 3. re-tag & save ----------
      - name: Re-tag and save images
        run: |
          mkdir tars
          # 外部镜像
          docker tag ghcr.io/tursodatabase/libsql-server:latest \
                     ${{ env.REGISTRY_PREFIX }}/libsql:${{ env.FIXED_TAG }}
          docker tag tinybirdco/tinybird-local:latest \
                     ${{ env.REGISTRY_PREFIX }}/tinybird-local:${{ env.FIXED_TAG }}

          # 自研镜像
          for img in workflows server private-location dashboard status-page; do
            docker tag openstatus/${img}:latest \
                       ${{ env.REGISTRY_PREFIX }}/${img}:${{ env.FIXED_TAG }}
          done

          # 统一导出
          for img in libsql tinybird-local workflows server private-location dashboard status-page; do
            docker save ${{ env.REGISTRY_PREFIX }}/${img}:${{ env.FIXED_TAG }} \
              | gzip > tars/${img}-${{ env.FIXED_TAG }}.tar.gz
          done

      # ---------- 4. 打包 Artifact ----------
      - name: Create single zip
        run: |
          zip -j openstatus-images-${{ env.FIXED_TAG }}.zip tars/*.tar.gz

      - name: Upload artifact (7 days retention)
        uses: actions/upload-artifact@v4
        with:
          name: openstatus-images-${{ env.FIXED_TAG }}
          path: openstatus-images-${{ env.FIXED_TAG }}.zip
          retention-days: 7
